<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXトレード計算機 - Complete Edition</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-blue: #3182ce;
            --accent-green: #38a169;
            --accent-orange: #dd6b20;
            --bg-color: #f0f4f8;
            --loss-color: #e53e3e;
            --profit-color: #2c7a7b;
        }

        body { font-family: sans-serif; padding: 10px; background: var(--bg-color); margin: 0; }
        .container { max-width: 450px; margin: auto; }
        
        .tabs { display: flex; margin-bottom: 10px; background: #e2e8f0; border-radius: 8px; padding: 4px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-radius: 6px; font-weight: bold; color: #4a5568; transition: 0.3s; }
        .tab-btn.active { background: white; color: var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .box { background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; }
        .box.active { display: block; }

        h2 { text-align: center; margin: 0 0 15px 0; color: var(--primary-color); font-size: 18px; }
        
        .input-group { margin-bottom: 10px; }
        label { display: block; font-weight: bold; font-size: 12px; color: #444; margin-bottom: 3px; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .results-container { margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .result-card { padding: 12px 5px; border-radius: 10px; text-align: center; border: 2px solid #edf2f7; }
        .card-danger { background: #fff5f5; border-color: #feb2b2; grid-column: span 3; }
        .card-info { background: #ebf8ff; border-color: #90cdf4; }
        .card-success { background: #f0fff4; border-color: #9ae6b4; }
        .card-orange { background: #fffaf0; border-color: #fbd38d; }

        .res-label { font-size: 11px; font-weight: bold; color: #4a5568; margin-bottom: 5px; }
        .res-value { font-size: 18px; font-weight: bold; color: #2d3748; }
        #resLcRate { color: #e53e3e; font-size: 28px; }
        #m_resPipsToLc { color: #e53e3e; font-weight: bold; }
        .res-unit { font-size: 11px; margin-left: 2px; }

        .note { font-size: 11px; color: #718096; margin-top: 15px; line-height: 1.5; background: #f7fafc; padding: 10px; border-radius: 6px; white-space: pre-line; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('profitTab')">損益・pips</button>
        <button class="tab-btn" onclick="showTab('marginTab')">証拠金・ロスカット</button>
    </div>

    <div id="profitTab" class="box active">
        <h2>損益額・損益pips 計算</h2>
        <div class="grid-2">
            <div class="input-group">
                <label>通貨ペア種別</label>
                <select id="p_type" onchange="profitChangeType()">
                    <option value="jpy">クロス円</option>
                    <option value="usd">ドルストレート</option>
                    <option value="eurgbp">ユーロポンド</option>
                </select>
            </div>
            <div class="input-group">
                <label>売買</label>
                <select id="p_side" onchange="profitRun()">
                    <option value="buy">買い</option>
                    <option value="sell">売り</option>
                </select>
            </div>
        </div>
        <div class="grid-2">
            <div class="input-group">
                <label>エントリーレート</label>
                <input type="number" id="p_entry" value="150.000" step="0.001" oninput="profitRun()">
            </div>
            <div class="input-group">
                <label>決済レート</label>
                <input type="number" id="p_settle" value="150.500" step="0.001" oninput="profitRun()">
            </div>
        </div>
        <div class="input-group">
            <label>取引数量 (通貨)</label>
            <input type="text" id="p_qty" value="10,000" oninput="formatInput(this); profitRun();">
        </div>
        <div id="p_rateBox" style="display:none;">
            <div class="input-group">
                <label id="p_rateLabel">対円為替レート</label>
                <input type="number" id="p_baseRate" value="150.00" step="0.01" oninput="profitRun()">
            </div>
        </div>
        <div class="results-container" style="grid-template-columns: 1fr 1fr;">
            <div class="result-card" id="cardProfit" style="background: #f0fff4; border-color: #9ae6b4; grid-column: span 1;">
                <div class="res-label">損益額</div>
                <div class="res-value" id="resProfit">---</div><span class="res-unit">円</span>
            </div>
            <div class="result-card" id="cardPips" style="background: #fffaf0; border-color: #fbd38d; grid-column: span 1;">
                <div class="res-label">損益pips</div>
                <div class="res-value" id="resPips">---</div><span class="res-unit">pips</span>
            </div>
        </div>
        <div class="note" id="p_note">pips計算: 0.01 = 1pips</div>
    </div>

    <div id="marginTab" class="box">
        <h2>証拠金・ロスカット計算</h2>
        <div class="grid-2">
            <div class="input-group">
                <label>通貨ペア種別</label>
                <select id="m_type" onchange="marginChangeType()">
                    <option value="jpy">クロス円</option>
                    <option value="usd">ドルストレート</option>
                    <option value="eurgbp">ユーロポンド</option>
                </select>
            </div>
            <div class="input-group">
                <label>売買</label>
                <select id="m_side" onchange="marginRun()">
                    <option value="buy">買い</option>
                    <option value="sell">売り</option>
                </select>
            </div>
        </div>
        <div class="grid-2">
            <div class="input-group">
                <label>エントリーレート</label>
                <input type="number" id="m_entry" value="150.000" step="0.001" oninput="marginRun()">
            </div>
            <div class="input-group">
                <label>最大レバレッジ (倍)</label>
                <input type="number" id="m_maxLev" value="25" oninput="marginRun()">
            </div>
        </div>
        <div class="input-group">
            <label>口座残高 (円)</label>
            <input type="text" id="m_balance" value="100,000" oninput="formatInput(this); marginRun();">
        </div>
        <div class="input-group">
            <label>取引数量 (通貨)</label>
            <input type="text" id="m_qty" value="10,000" oninput="formatInput(this); marginRun();">
        </div>
        <div id="m_rateBox" style="display:none;">
            <div class="input-group">
                <label id="m_rateLabel">対円レート</label>
                <input type="number" id="m_baseRate" value="150.00" step="0.01" oninput="marginRun()">
            </div>
        </div>
        <div class="results-container">
            <div class="result-card card-danger">
                <div class="res-label">ロスカットレート</div>
                <div class="res-value" id="resLcRate">---</div>
                <div style="font-size: 13px; margin-top: 5px;">
                    あと <span id="m_resPipsToLc">---</span> pips でロスカット
                </div>
            </div>
            <div class="result-card card-info">
                <div class="res-label">必要証拠金</div>
                <div class="res-value" id="resMargin">---</div><span class="res-unit">円</span>
            </div>
            <div class="result-card card-info">
                <div class="res-label">維持率</div>
                <div class="res-value" id="resRatio">---</div><span class="res-unit">%</span>
            </div>
            <div class="result-card card-success">
                <div class="res-label">実効レバ</div>
                <div class="res-value" id="resEffLev">---</div><span class="res-unit">倍</span>
            </div>
        </div>
        <div class="note">※ 維持率100%でロスカットと仮定しています。</div>
    </div>
</div>

<script>
function showTab(tabId) {
    document.querySelectorAll('.box').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    const btns = document.querySelectorAll('.tab-btn');
    if(tabId === 'profitTab') btns[0].classList.add('active');
    else btns[1].classList.add('active');
}

function formatInput(input) {
    let val = input.value.replace(/,/g, '');
    if (!isNaN(val) && val !== '') input.value = Number(val).toLocaleString();
}

function parseVal(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    return parseFloat(el.value.replace(/,/g, '')) || 0;
}

// --- 証拠金・ロスカット計算 ---
function marginChangeType() {
    const type = document.getElementById('m_type').value;
    const rateBox = document.getElementById('m_rateBox');
    const rateLabel = document.getElementById('m_rateLabel');
    const entry = document.getElementById('m_entry');

    if (type === 'jpy') {
        rateBox.style.display = 'none';
        if (parseFloat(entry.value) < 2) entry.value = "150.000";
    } else if (type === 'usd') {
        rateBox.style.display = 'block';
        rateLabel.innerText = "ドル円レート (USD/JPY)";
        if (parseFloat(entry.value) > 2) entry.value = "1.08000";
    } else if (type === 'eurgbp') {
        rateBox.style.display = 'block';
        rateLabel.innerText = "ポンド円レート (GBP/JPY)";
        if (parseFloat(entry.value) > 2) entry.value = "0.85000";
    }
    marginRun();
}

function marginRun() {
    const type = document.getElementById('m_type').value;
    const side = document.getElementById('m_side').value;
    const entry = parseVal('m_entry');
    const balance = parseVal('m_balance');
    const qty = parseVal('m_qty');
    const maxLev = parseVal('m_maxLev');
    const baseRate = parseVal('m_baseRate');

    if (qty <= 0 || entry <= 0 || balance <= 0 || maxLev <= 0) return;

    // 必要証拠金の算出用レート
    let calcRate = (type === 'jpy') ? entry : (entry * baseRate);
    
    // 必要証拠金 = (レート × 数量) / レバレッジ
    let requiredMargin = (calcRate * qty) / maxLev;
    let marginRatio = (balance / requiredMargin) * 100;
    let effectiveLev = (calcRate * qty) / balance;
    
    // 許容損失額 (維持率100%想定)
    let allowableLoss = balance - requiredMargin;
    
    // 1pipsの単位
    let pipsUnit = (type === 'jpy') ? 0.01 : 0.0001;
    
    // ロスカットまでの値幅
    let lcDiff = (type === 'jpy') ? (allowableLoss / qty) : (allowableLoss / qty / baseRate);
    let lcRate = (side === 'buy') ? (entry - lcDiff) : (entry + lcDiff);
    let pipsToLc = Math.abs(entry - lcRate) / pipsUnit;

    // 結果反映
    document.getElementById('resMargin').innerText = Math.round(requiredMargin).toLocaleString();
    document.getElementById('resRatio').innerText = Math.round(marginRatio).toLocaleString();
    document.getElementById('resEffLev').innerText = effectiveLev.toFixed(2);
    document.getElementById('resLcRate').innerText = (type === 'jpy') ? lcRate.toFixed(3) : lcRate.toFixed(5);
    document.getElementById('m_resPipsToLc').innerText = Math.round(pipsToLc).toLocaleString();
}

// --- 損益計算 ---
function profitChangeType() {
    const type = document.getElementById('p_type').value;
    const rateBox = document.getElementById('p_rateBox');
    const note = document.getElementById('p_note');
    const entry = document.getElementById('p_entry');
    const settle = document.getElementById('p_settle');

    if (type === 'jpy') {
        rateBox.style.display = 'none';
        note.innerText = "pips計算: 0.01 = 1pips";
        if (parseFloat(entry.value) < 2) { entry.value = "150.000"; settle.value = "150.500"; }
    } else {
        rateBox.style.display = 'block';
        note.innerText = "pips計算: 0.0001 = 1pips";
        if (parseFloat(entry.value) > 2) { entry.value = "1.08000"; settle.value = "1.08500"; }
    }
    profitRun();
}

function profitRun() {
    const type = document.getElementById('p_type').value;
    const side = document.getElementById('p_side').value;
    const entry = parseVal('p_entry');
    const settle = parseVal('p_settle');
    const qty = parseVal('p_qty');
    const baseRate = parseVal('p_baseRate');

    if (qty <= 0) return;

    const diff = (side === 'buy') ? (settle - entry) : (entry - settle);
    let pips = (type === 'jpy') ? diff / 0.01 : diff / 0.0001;
    let profit = (type === 'jpy') ? diff * qty : diff * qty * baseRate;

    const resPipsEl = document.getElementById('resPips');
    const resProfitEl = document.getElementById('resProfit');

    resPipsEl.innerText = (pips > 0 ? "+" : "") + pips.toFixed(1);
    resProfitEl.innerText = (profit > 0 ? "+" : "") + Math.round(profit).toLocaleString();

    if (profit > 0) {
        resProfitEl.style.color = "var(--profit-color)";
        resPipsEl.style.color = "var(--accent-orange)";
    } else if (profit < 0) {
        resProfitEl.style.color = "var(--loss-color)";
        resPipsEl.style.color = "var(--loss-color)";
    } else {
        resProfitEl.style.color = "var(--primary-color)";
        resPipsEl.style.color = "var(--primary-color)";
    }
}

window.onload = () => { 
    marginRun(); 
    profitRun(); 
};
</script>
</body>
</html>
